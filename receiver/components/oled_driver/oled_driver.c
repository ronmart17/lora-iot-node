#include "oled_driver.h"
#include "driver/i2c.h"
#include "driver/gpio.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_log.h"
#include <string.h>

static const char *TAG = "OLED";

/* ---------- Heltec WiFi LoRa 32 V3 pin config ---------- */
#define I2C_MASTER_NUM      I2C_NUM_0
#define I2C_SDA_PIN         17
#define I2C_SCL_PIN         18
#define OLED_RST_PIN        21
#define OLED_VEXT_PIN       36      /* LOW = power on OLED */
#define I2C_FREQ_HZ         400000
#define SSD1306_ADDR        0x3C

/* ---------- SSD1306 commands ---------- */
#define CMD_DISPLAY_OFF     0xAE
#define CMD_DISPLAY_ON      0xAF
#define CMD_SET_MUX_RATIO   0xA8
#define CMD_SET_OFFSET      0xD3
#define CMD_SET_START_LINE  0x40
#define CMD_SET_SEG_REMAP   0xA1
#define CMD_SET_COM_SCAN    0xC8
#define CMD_SET_COM_PINS    0xDA
#define CMD_SET_CONTRAST    0x81
#define CMD_ENTIRE_ON_RES   0xA4
#define CMD_SET_NORMAL      0xA6
#define CMD_SET_CLK_DIV     0xD5
#define CMD_SET_CHARGE_PUMP 0x8D
#define CMD_SET_MEMORY_MODE 0x20
#define CMD_SET_COL_ADDR    0x21
#define CMD_SET_PAGE_ADDR   0x22

/* ---------- Frame buffer ---------- */
#define BUF_SIZE (OLED_WIDTH * OLED_HEIGHT / 8)  /* 1024 bytes */
static uint8_t framebuf[BUF_SIZE];

/* ---------- 6x8 ASCII font (chars 32-126) ---------- */
static const uint8_t font6x8[][6] = {
    {0x00,0x00,0x00,0x00,0x00,0x00}, /*   */
    {0x00,0x00,0x5F,0x00,0x00,0x00}, /* ! */
    {0x00,0x07,0x00,0x07,0x00,0x00}, /* " */
    {0x14,0x7F,0x14,0x7F,0x14,0x00}, /* # */
    {0x24,0x2A,0x7F,0x2A,0x12,0x00}, /* $ */
    {0x23,0x13,0x08,0x64,0x62,0x00}, /* % */
    {0x36,0x49,0x55,0x22,0x50,0x00}, /* & */
    {0x00,0x05,0x03,0x00,0x00,0x00}, /* ' */
    {0x00,0x1C,0x22,0x41,0x00,0x00}, /* ( */
    {0x00,0x41,0x22,0x1C,0x00,0x00}, /* ) */
    {0x08,0x2A,0x1C,0x2A,0x08,0x00}, /* * */
    {0x08,0x08,0x3E,0x08,0x08,0x00}, /* + */
    {0x00,0x50,0x30,0x00,0x00,0x00}, /* , */
    {0x08,0x08,0x08,0x08,0x08,0x00}, /* - */
    {0x00,0x60,0x60,0x00,0x00,0x00}, /* . */
    {0x20,0x10,0x08,0x04,0x02,0x00}, /* / */
    {0x3E,0x51,0x49,0x45,0x3E,0x00}, /* 0 */
    {0x00,0x42,0x7F,0x40,0x00,0x00}, /* 1 */
    {0x42,0x61,0x51,0x49,0x46,0x00}, /* 2 */
    {0x21,0x41,0x45,0x4B,0x31,0x00}, /* 3 */
    {0x18,0x14,0x12,0x7F,0x10,0x00}, /* 4 */
    {0x27,0x45,0x45,0x45,0x39,0x00}, /* 5 */
    {0x3C,0x4A,0x49,0x49,0x30,0x00}, /* 6 */
    {0x01,0x71,0x09,0x05,0x03,0x00}, /* 7 */
    {0x36,0x49,0x49,0x49,0x36,0x00}, /* 8 */
    {0x06,0x49,0x49,0x29,0x1E,0x00}, /* 9 */
    {0x00,0x36,0x36,0x00,0x00,0x00}, /* : */
    {0x00,0x56,0x36,0x00,0x00,0x00}, /* ; */
    {0x00,0x08,0x14,0x22,0x41,0x00}, /* < */
    {0x14,0x14,0x14,0x14,0x14,0x00}, /* = */
    {0x41,0x22,0x14,0x08,0x00,0x00}, /* > */
    {0x02,0x01,0x51,0x09,0x06,0x00}, /* ? */
    {0x32,0x49,0x79,0x41,0x3E,0x00}, /* @ */
    {0x7E,0x11,0x11,0x11,0x7E,0x00}, /* A */
    {0x7F,0x49,0x49,0x49,0x36,0x00}, /* B */
    {0x3E,0x41,0x41,0x41,0x22,0x00}, /* C */
    {0x7F,0x41,0x41,0x22,0x1C,0x00}, /* D */
    {0x7F,0x49,0x49,0x49,0x41,0x00}, /* E */
    {0x7F,0x09,0x09,0x01,0x01,0x00}, /* F */
    {0x3E,0x41,0x41,0x51,0x32,0x00}, /* G */
    {0x7F,0x08,0x08,0x08,0x7F,0x00}, /* H */
    {0x00,0x41,0x7F,0x41,0x00,0x00}, /* I */
    {0x20,0x40,0x41,0x3F,0x01,0x00}, /* J */
    {0x7F,0x08,0x14,0x22,0x41,0x00}, /* K */
    {0x7F,0x40,0x40,0x40,0x40,0x00}, /* L */
    {0x7F,0x02,0x04,0x02,0x7F,0x00}, /* M */
    {0x7F,0x04,0x08,0x10,0x7F,0x00}, /* N */
    {0x3E,0x41,0x41,0x41,0x3E,0x00}, /* O */
    {0x7F,0x09,0x09,0x09,0x06,0x00}, /* P */
    {0x3E,0x41,0x51,0x21,0x5E,0x00}, /* Q */
    {0x7F,0x09,0x19,0x29,0x46,0x00}, /* R */
    {0x46,0x49,0x49,0x49,0x31,0x00}, /* S */
    {0x01,0x01,0x7F,0x01,0x01,0x00}, /* T */
    {0x3F,0x40,0x40,0x40,0x3F,0x00}, /* U */
    {0x1F,0x20,0x40,0x20,0x1F,0x00}, /* V */
    {0x7F,0x20,0x18,0x20,0x7F,0x00}, /* W */
    {0x63,0x14,0x08,0x14,0x63,0x00}, /* X */
    {0x03,0x04,0x78,0x04,0x03,0x00}, /* Y */
    {0x61,0x51,0x49,0x45,0x43,0x00}, /* Z */
    {0x00,0x00,0x7F,0x41,0x41,0x00}, /* [ */
    {0x02,0x04,0x08,0x10,0x20,0x00}, /* \ */
    {0x41,0x41,0x7F,0x00,0x00,0x00}, /* ] */
    {0x04,0x02,0x01,0x02,0x04,0x00}, /* ^ */
    {0x40,0x40,0x40,0x40,0x40,0x00}, /* _ */
    {0x00,0x01,0x02,0x04,0x00,0x00}, /* ` */
    {0x20,0x54,0x54,0x54,0x78,0x00}, /* a */
    {0x7F,0x48,0x44,0x44,0x38,0x00}, /* b */
    {0x38,0x44,0x44,0x44,0x20,0x00}, /* c */
    {0x38,0x44,0x44,0x48,0x7F,0x00}, /* d */
    {0x38,0x54,0x54,0x54,0x18,0x00}, /* e */
    {0x08,0x7E,0x09,0x01,0x02,0x00}, /* f */
    {0x08,0x14,0x54,0x54,0x3C,0x00}, /* g */
    {0x7F,0x08,0x04,0x04,0x78,0x00}, /* h */
    {0x00,0x44,0x7D,0x40,0x00,0x00}, /* i */
    {0x20,0x40,0x44,0x3D,0x00,0x00}, /* j */
    {0x00,0x7F,0x10,0x28,0x44,0x00}, /* k */
    {0x00,0x41,0x7F,0x40,0x00,0x00}, /* l */
    {0x7C,0x04,0x18,0x04,0x78,0x00}, /* m */
    {0x7C,0x08,0x04,0x04,0x78,0x00}, /* n */
    {0x38,0x44,0x44,0x44,0x38,0x00}, /* o */
    {0x7C,0x14,0x14,0x14,0x08,0x00}, /* p */
    {0x08,0x14,0x14,0x18,0x7C,0x00}, /* q */
    {0x7C,0x08,0x04,0x04,0x08,0x00}, /* r */
    {0x48,0x54,0x54,0x54,0x20,0x00}, /* s */
    {0x04,0x3F,0x44,0x40,0x20,0x00}, /* t */
    {0x3C,0x40,0x40,0x20,0x7C,0x00}, /* u */
    {0x1C,0x20,0x40,0x20,0x1C,0x00}, /* v */
    {0x3C,0x40,0x30,0x40,0x3C,0x00}, /* w */
    {0x44,0x28,0x10,0x28,0x44,0x00}, /* x */
    {0x0C,0x50,0x50,0x50,0x3C,0x00}, /* y */
    {0x44,0x64,0x54,0x4C,0x44,0x00}, /* z */
    {0x00,0x08,0x36,0x41,0x00,0x00}, /* { */
    {0x00,0x00,0x7F,0x00,0x00,0x00}, /* | */
    {0x00,0x41,0x36,0x08,0x00,0x00}, /* } */
    {0x08,0x08,0x2A,0x1C,0x08,0x00}, /* ~ */
};

/* -------------------------------------------------- */
/*              Low-level I2C helpers                  */
/* -------------------------------------------------- */

static esp_err_t oled_send_cmd(uint8_t cmd)
{
    uint8_t buf[2] = { 0x00, cmd };          /* Co=0, D/C#=0 */
    return i2c_master_write_to_device(I2C_MASTER_NUM, SSD1306_ADDR,
                                      buf, sizeof(buf),
                                      pdMS_TO_TICKS(100));
}

static esp_err_t oled_send_data(const uint8_t *data, size_t len)
{
    uint8_t *buf = malloc(len + 1);
    if (!buf) return ESP_ERR_NO_MEM;
    buf[0] = 0x40;                           /* Co=0, D/C#=1 */
    memcpy(buf + 1, data, len);
    esp_err_t ret = i2c_master_write_to_device(I2C_MASTER_NUM, SSD1306_ADDR,
                                                buf, len + 1,
                                                pdMS_TO_TICKS(100));
    free(buf);
    return ret;
}

/* -------------------------------------------------- */
/*                 Public API                          */
/* -------------------------------------------------- */

void oled_driver_init(void)
{
    /* Power on OLED via Vext (active LOW on Heltec V3) */
    gpio_config_t vext_cfg = {
        .pin_bit_mask = (1ULL << OLED_VEXT_PIN),
        .mode         = GPIO_MODE_OUTPUT,
    };
    gpio_config(&vext_cfg);
    gpio_set_level(OLED_VEXT_PIN, 0);       /* LOW = OLED power ON */
    vTaskDelay(pdMS_TO_TICKS(20));

    /* Hardware reset of SSD1306 */
    gpio_config_t rst_cfg = {
        .pin_bit_mask = (1ULL << OLED_RST_PIN),
        .mode         = GPIO_MODE_OUTPUT,
    };
    gpio_config(&rst_cfg);
    gpio_set_level(OLED_RST_PIN, 0);
    vTaskDelay(pdMS_TO_TICKS(20));
    gpio_set_level(OLED_RST_PIN, 1);
    vTaskDelay(pdMS_TO_TICKS(20));

    /* Configure I2C master */
    i2c_config_t conf = {
        .mode             = I2C_MODE_MASTER,
        .sda_io_num       = I2C_SDA_PIN,
        .scl_io_num       = I2C_SCL_PIN,
        .sda_pullup_en    = GPIO_PULLUP_ENABLE,
        .scl_pullup_en    = GPIO_PULLUP_ENABLE,
        .master.clk_speed = I2C_FREQ_HZ,
    };
    i2c_param_config(I2C_MASTER_NUM, &conf);
    i2c_driver_install(I2C_MASTER_NUM, I2C_MODE_MASTER, 0, 0, 0);

    /* SSD1306 initialisation sequence */
    oled_send_cmd(CMD_DISPLAY_OFF);
    oled_send_cmd(CMD_SET_CLK_DIV);    oled_send_cmd(0x80);
    oled_send_cmd(CMD_SET_MUX_RATIO);  oled_send_cmd(0x3F);  /* 64 lines */
    oled_send_cmd(CMD_SET_OFFSET);     oled_send_cmd(0x00);
    oled_send_cmd(CMD_SET_START_LINE);
    oled_send_cmd(CMD_SET_CHARGE_PUMP);oled_send_cmd(0x14);   /* enable */
    oled_send_cmd(CMD_SET_MEMORY_MODE); oled_send_cmd(0x00);  /* horizontal */
    oled_send_cmd(CMD_SET_SEG_REMAP);
    oled_send_cmd(CMD_SET_COM_SCAN);
    oled_send_cmd(CMD_SET_COM_PINS);   oled_send_cmd(0x12);
    oled_send_cmd(CMD_SET_CONTRAST);   oled_send_cmd(0xCF);
    oled_send_cmd(CMD_ENTIRE_ON_RES);
    oled_send_cmd(CMD_SET_NORMAL);
    oled_send_cmd(CMD_DISPLAY_ON);

    oled_driver_clear();
    oled_driver_update();

    ESP_LOGI(TAG, "SSD1306 OLED initialized (%dx%d)", OLED_WIDTH, OLED_HEIGHT);
}

void oled_driver_clear(void)
{
    memset(framebuf, 0, BUF_SIZE);
}

void oled_driver_print(int x, int y, const char *text, oled_font_t font)
{
    (void)font;   /* only OLED_FONT_SMALL for now */
    if (!text) return;

    for (const char *p = text; *p; p++) {
        uint8_t c = (uint8_t)*p;
        if (c < 32 || c > 126) c = '?';

        const uint8_t *glyph = font6x8[c - 32];

        for (int col = 0; col < 6; col++) {
            int px = x + col;
            if (px < 0 || px >= OLED_WIDTH) continue;

            uint8_t column_data = glyph[col];
            for (int bit = 0; bit < 8; bit++) {
                int py = y + bit;
                if (py < 0 || py >= OLED_HEIGHT) continue;
                if (column_data & (1 << bit)) {
                    framebuf[(py / 8) * OLED_WIDTH + px] |= (1 << (py % 8));
                }
            }
        }
        x += 6;
    }
}

void oled_driver_draw_hline(int x1, int x2, int y)
{
    if (y < 0 || y >= OLED_HEIGHT) return;
    if (x1 > x2) { int t = x1; x1 = x2; x2 = t; }
    if (x1 < 0) x1 = 0;
    if (x2 >= OLED_WIDTH) x2 = OLED_WIDTH - 1;

    for (int x = x1; x <= x2; x++) {
        framebuf[(y / 8) * OLED_WIDTH + x] |= (1 << (y % 8));
    }
}

void oled_driver_update(void)
{
    /* Set column and page range to full screen */
    oled_send_cmd(CMD_SET_COL_ADDR);
    oled_send_cmd(0);
    oled_send_cmd(OLED_WIDTH - 1);

    oled_send_cmd(CMD_SET_PAGE_ADDR);
    oled_send_cmd(0);
    oled_send_cmd((OLED_HEIGHT / 8) - 1);

    /* Send framebuffer in chunks (I2C limit) */
    const int chunk = 128;
    for (int i = 0; i < BUF_SIZE; i += chunk) {
        int len = (BUF_SIZE - i) < chunk ? (BUF_SIZE - i) : chunk;
        oled_send_data(framebuf + i, len);
    }
}
